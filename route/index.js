var express=require("express"),router=express.Router(),userCon=require("../dao/dbCon"),uuidV4=require("uuid/v4"),changesets=require("changesets"),dmpod=require("diff-match-patch"),dmp=new dmpod.diff_match_patch,art_temp=require("art-template");require.extensions[".ejs"]=art_temp.extension;var multer=require("multer"),md5=require("md5"),diff0='<div tabindex="1" spellcheck="false" contenteditable="true" class="note-view" style="visibility: visible;"><div class="highlight-view" style="display: none;"></div><div class="block-view paragraph-view" data-yne-cid="view43"><div class="para-text" style="line-height: 1.875; text-align: left; font-size: 14px;"><span style="color: rgb(57, 57, 57); font-family: -apple-system, BlinkMacSystemFont, &quot;PingFang SC&quot;, Helvetica, Tahoma, Arial, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, 微软雅黑, SimSun, 宋体, Heiti, 黑体, sans-serif; font-size: 14px; background-color: transparent; font-weight: normal; font-style: normal; text-decoration: none;">模块化的好处：</span></div></div><div class="block-view paragraph-view" data-yne-cid="view44"><div class="para-text" style="line-height: 1.875; text-align: left; font-size: 14px;"><span style="color: rgb(57, 57, 57); font-family: -apple-system, BlinkMacSystemFont, &quot;PingFang SC&quot;, Helvetica, Tahoma, Arial, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, 微软雅黑, SimSun, 宋体, Heiti, 黑体, sans-serif; font-size: 14px; background-color: transparent; font-weight: normal; font-style: normal; text-decoration: none;">1、</span><span style="color: rgb(255, 0, 0); font-family: -apple-system, BlinkMacSystemFont, &quot;PingFang SC&quot;, Helvetica, Tahoma, Arial, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, 微软雅黑, SimSun, 宋体, Heiti, 黑体, sans-serif; font-size: 14px; background-color: transparent; font-weight: normal; font-style: normal; text-decoration: none;">可维护性：</span><span style="color: rgb(57, 57, 57); font-family: -apple-system, BlinkMacSystemFont, &quot;PingFang SC&quot;, Helvetica, Tahoma, Arial, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, 微软雅黑, SimSun, 宋体, Heiti, 黑体, sans-serif; font-size: 14px; background-color: transparent; font-weight: normal; font-style: normal; text-decoration: none;">根据定义，没个模块都是独立的。良好设计的模块会尽量与外界代码分隔开，减少关联，以便独立地维护和改进。维护一个独立的代码团，要比一整团代码来的轻松。</span></div></div><div class="block-view paragraph-view" data-yne-cid="view45"><div class="para-text" style="line-height: 1.875; text-align: left; font-size: 14px;"><span style="color: rgb(57, 57, 57); font-family: -apple-system, BlinkMacSystemFont, &quot;PingFang SC&quot;, Helvetica, Tahoma, Arial, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, 微软雅黑, SimSun, 宋体, Heiti, 黑体, sans-serif; font-size: 14px; background-color: transparent; font-weight: normal; font-style: normal; text-decoration: none;">2、</span><span style="color: rgb(255, 0, 0); font-family: -apple-system, BlinkMacSystemFont, &quot;PingFang SC&quot;, Helvetica, Tahoma, Arial, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, 微软雅黑, SimSun, 宋体, Heiti, 黑体, sans-serif; font-size: 14px; background-color: transparent; font-weight: normal; font-style: normal; text-decoration: none;">命名空间：</span><span style="color: rgb(57, 57, 57); font-family: -apple-system, BlinkMacSystemFont, &quot;PingFang SC&quot;, Helvetica, Tahoma, Arial, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, 微软雅黑, SimSun, 宋体, Heiti, 黑体, sans-serif; font-size: 14px; background-color: transparent; font-weight: normal; font-style: normal; text-decoration: none;">在JavaScript中，最高级别函数外定义的变量都是全局变量（所有人都能访问到），也正因为如此，当一些无关代码碰巧使用同名变量时， 就会遇到“命名空间污染”的问题。</span></div></div><div class="block-view paragraph-view" data-yne-cid="view46"><div class="para-text" style="line-height: 1.875; text-align: left; font-size: 14px;"><span style="color: rgb(57, 57, 57); font-family: -apple-system, BlinkMacSystemFont, &quot;PingFang SC&quot;, Helvetica, Tahoma, Arial, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, 微软雅黑, SimSun, 宋体, Heiti, 黑体, sans-serif; font-size: 14px; background-color: transparent; font-weight: normal; font-style: normal; text-decoration: none;">3、</span><span style="color: rgb(255, 0, 0); font-family: -apple-system, BlinkMacSystemFont, &quot;PingFang SC&quot;, Helvetica, Tahoma, Arial, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, 微软雅黑, SimSun, 宋体, Heiti, 黑体, sans-serif; font-size: 14px; background-color: transparent; font-weight: normal; font-style: normal; text-decoration: none;">可复用性：</span><span style="color: rgb(57, 57, 57); font-family: -apple-system, BlinkMacSystemFont, &quot;PingFang SC&quot;, Helvetica, Tahoma, Arial, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, 微软雅黑, SimSun, 宋体, Heiti, 黑体, sans-serif; font-size: 14px; background-color: transparent; font-weight: normal; font-style: normal; text-decoration: none;">在日常中写的代码，有时候觉得自己写的老好老好的，但是下次想用的时候，又要去找，然后复制过来改参数，那为什么不写一个类似插件的东西，对代码进行封装呢。不是复制粘贴，而是直接引用优秀的旧代码。</span></div></div></div>',diff1='<div tabindex="1" spellcheck="false" contenteditable="true" class="note-view" style="visibility: visible;"><div class="highlight-view" style="display: none;"></div><div class="block-view paragraph-view" data-yne-cid="view43"><div class="para-text" style="line-height: 1.875; text-align: left; font-size: 14px;"><span style="color: rgb(57, 57, 57); font-family: -apple-system, BlinkMacSystemFont, &quot;PingFang SC&quot;, Helvetica, Tahoma, Arial, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, 微软雅黑, SimSun, 宋体, Heiti, 黑体, sans-serif; font-size: 14px; background-color: transparent; font-weight: normal; font-style: normal; text-decoration: none;">模块化的好处：</span></div></div><div class="block-view paragraph-view" data-yne-cid="view44"><div class="para-text" style="line-height: 1.875; text-align: left; font-size: 14px;"><span style="color: rgb(57, 57, 57); font-family: -apple-system, BlinkMacSystemFont, &quot;PingFang SC&quot;, Helvetica, Tahoma, Arial, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, 微软雅黑, SimSun, 宋体, Heiti, 黑体, sans-serif; font-size: 14px; background-color: transparent; font-weight: normal; font-style: normal; text-decoration: none;">1、</span><span style="color: rgb(255, 0, 0); font-family: -apple-system, BlinkMacSystemFont, &quot;PingFang SC&quot;, Helvetica, Tahoma, Arial, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, 微软雅黑, SimSun, 宋体, Heiti, 黑体, sans-serif; font-size: 14px; background-color: transparent; font-weight: normal; font-style: normal; text-decoration: none;">可维护性：</span><span style="color: rgb(57, 57, 57); font-family: -apple-system, BlinkMacSystemFont, &quot;PingFang SC&quot;, Helvetica, Tahoma, Arial, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, 微软雅黑, SimSun, 宋体, Heiti, 黑体, sans-serif; font-size: 14px; background-color: transparent; font-weight: normal; font-style: normal; text-decoration: none;">根据定义，没个模块都是独立的。良好设计的模块会尽量与外界代码分隔开，减少关联，以便独立地维护和改进。维护一个独立的代码团，要比一整团代码来的轻松。</span></div></div><div class="block-view paragraph-view" data-yne-cid="view45"><div class="para-text" style="line-height: 1.875; text-align: left; font-size: 14px;"><span style="color: rgb(57, 57, 57); font-family: -apple-system, BlinkMacSystemFont, &quot;PingFang SC&quot;, Helvetica, Tahoma, Arial, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, 微软雅黑, SimSun, 宋体, Heiti, 黑体, sans-serif; font-size: 14px; background-color: transparent; font-weight: normal; font-style: normal; text-decoration: none;">2、</span><span style="color: rgb(255, 0, 0); font-family: -apple-system, BlinkMacSystemFont, &quot;PingFang SC&quot;, Helvetica, Tahoma, Arial, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, 微软雅黑, SimSun, 宋体, Heiti, 黑体, sans-serif; font-size: 14px; background-color: transparent; font-weight: normal; font-style: normal; text-decoration: none;">命名空间：</span><span style="color: rgb(57, 57, 57); font-family: -apple-system, BlinkMacSystemFont, &quot;PingFang SC&quot;, Helvetica, Tahoma, Arial, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, 微软雅黑, SimSun, 宋体, Heiti, 黑体, sans-serif; font-size: 14px; background-color: transparent; font-weight: normal; font-style: normal; text-decoration: none;">在JavaScript中，最高级别函数外定义的变量都是全局变量（所有人都能访问到），也正因为如此，当一些无关代码碰巧使用同名变量时， 就会遇到“命名空间污染”的问题。</span></div></div><div class="block-view paragraph-view" data-yne-cid="view46"><div class="para-text" style="line-height: 1.875; text-align: left; font-size: 14px;"><span style="color: rgb(57, 57, 57); font-family: -apple-system, BlinkMacSystemFont, &quot;PingFang SC&quot;, Helvetica, Tahoma, Arial, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, 微软雅黑, SimSun, 宋体, Heiti, 黑体, sans-serif; font-size: 14px; background-color: transparent; font-weight: normal; font-style: normal; text-decoration: none;">3、</span><span style="color: rgb(255, 0, 0); font-family: -apple-system, BlinkMacSystemFont, &quot;PingFang SC&quot;, Helvetica, Tahoma, Arial, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, 微软雅黑, SimSun, 宋体, Heiti, 黑体, sans-serif; font-size: 14px; background-color: transparent; font-weight: normal; font-style: normal; text-decoration: none;">可复用性：</span><span style="color: rgb(57, 57, 57); font-family: -apple-system, BlinkMacSystemFont, &quot;PingFang SC&quot;, Helvetica, Tahoma, Arial, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, 微软雅黑, SimSun, 宋体, Heiti, 黑体, sans-serif; font-size: 14px; background-color: transparent; font-weight: normal; font-style: normal; text-decoration: none;">在日常中写的代码，有时候觉得自己写的老好老好的，但是下次想用的时候，又要去找，然后复制过来改参数，那为什么不写一个类似插件的东西，对代码进行封装呢。不是复制粘贴，而是直接引用优秀的旧代码。</span></div></div><div class="block-view paragraph-view" data-yne-cid="view47"><div class="para-text" style="line-height: 1.875; text-align: left; font-size: 14px;"><span style="color: rgb(57, 57, 57); font-family: -apple-system, BlinkMacSystemFont, &quot;PingFang SC&quot;, Helvetica, Tahoma, Arial, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, 微软雅黑, SimSun, 宋体, Heiti, 黑体, sans-serif; font-size: 14px; background-color: transparent; font-weight: normal; font-style: normal; text-decoration: none;">4、这是一条测试版本数据</span></div></div></div>',diff2='<div tabindex="1" spellcheck="false" contenteditable="true" class="note-view" style="visibility: visible;"><div class="highlight-view" style="display: none;"></div><div class="block-view paragraph-view" data-yne-cid="view43"><div class="para-text" style="line-height: 1.875; text-align: left; font-size: 14px;"><span style="color: rgb(57, 57, 57); font-family: -apple-system, BlinkMacSystemFont, &quot;PingFang SC&quot;, Helvetica, Tahoma, Arial, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, 微软雅黑, SimSun, 宋体, Heiti, 黑体, sans-serif; font-size: 14px; background-color: transparent; font-weight: normal; font-style: normal; text-decoration: none;">web前端（实习生）---杜豪</span></div></div><div class="block-view paragraph-view" data-yne-cid="view44"><div class="para-text" style="min-height: 25px; line-height: 1.875; text-align: left; font-size: 14px;"><br></div></div><div class="block-view paragraph-view" data-yne-cid="view45"><div class="para-text" style="line-height: 1.875; text-align: left; font-size: 14px;"><span style="color: rgb(57, 57, 57); font-family: -apple-system, BlinkMacSystemFont, &quot;PingFang SC&quot;, Helvetica, Tahoma, Arial, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, 微软雅黑, SimSun, 宋体, Heiti, 黑体, sans-serif; font-size: 14px; background-color: transparent; font-weight: normal; font-style: normal; text-decoration: none;">已做: 双旦建行提测·</span></div></div><div class="block-view paragraph-view" data-yne-cid="view46"><div class="para-text" style="min-height: 25px; line-height: 1.875; text-align: left; font-size: 14px;"><br></div></div><div class="block-view paragraph-view" data-yne-cid="view47"><div class="para-text" style="line-height: 1.875; text-align: left; font-size: 14px;"><span style="color: rgb(57, 57, 57); font-family: -apple-system, BlinkMacSystemFont, &quot;PingFang SC&quot;, Helvetica, Tahoma, Arial, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, 微软雅黑, SimSun, 宋体, Heiti, 黑体, sans-serif; font-size: 14px; background-color: transparent; font-weight: normal; font-style: normal; text-decoration: none;">正做: tffui更新（left-menu），双旦建行bug修改</span></div></div><div class="block-view paragraph-view" data-yne-cid="view48"><div class="para-text" style="min-height: 25px; line-height: 1.875; text-align: left; font-size: 14px;"><br></div></div><div class="block-view paragraph-view" data-yne-cid="view49"><div class="para-text" style="line-height: 1.875; text-align: left; font-size: 14px;"><span style="color: rgb(57, 57, 57); font-family: -apple-system, BlinkMacSystemFont, &quot;PingFang SC&quot;, Helvetica, Tahoma, Arial, &quot;Hiragino Sans GB&quot;, &quot;Microsoft YaHei&quot;, 微软雅黑, SimSun, 宋体, Heiti, 黑体, sans-serif; font-size: 14px; background-color: transparent; font-weight: normal; font-style: normal; text-decoration: none;">要做: 途风精品优化方案需求梳理</span></div></div></div>';console.log(decodeURI(dmp.patch_toText(dmp.patch_make(diff0,diff1))));for(var side_test_data=[],i=0;i<20;i++){var obj={folder_name:"笔记"+(i+1),level:1,folder_id:"folder"+(i+1)+"lv1",sub_list:[{folder_name:"level21",level:2,folder_id:"folder"+(i+1)+"lv21",sub_list:[{folder_name:"level3",level:3,folder_id:"folder"+(i+1)+"lv3",sub_list:[]}]},{folder_name:"level22",level:2,folder_id:"folder"+(i+1)+"lv22",sub_list:[]}]};side_test_data.push(obj)}for(var search_test_data=[],i=0;i<8;i++){var note_type=i%2==0?"note":"mk",obj={note_type:note_type};search_test_data.push(obj)}router.get("/home",function(t,e){t.session.islogin&&(e.locals.islogin=t.session.islogin),t.cookies.islogin&&(t.session.islogin=t.cookies.islogin),e.render("home",{title:"首页",user:e.locals.islogin,side_data:side_test_data,search_data:search_test_data})}),router.get("/",function(t,e){t.cookies.islogin&&(t.session.islogin=t.cookies.islogin),t.session.islogin&&(e.locals.islogin=t.session.islogin),e.render("index",{title:"首页",user:e.locals.islogin,side_data:side_test_data,search_data:search_test_data})}),router.route("/login").get(function(t,e){t.session.islogin&&(e.locals.islogin=t.session.islogin),t.cookies.islogin&&(t.session.islogin=t.cookies.islogin),e.render("login",{title:"用户登录",user:e.locals.islogin})}).post(function(t,e){client=userCon.connect(),result=null,userCon.userSelect(client,t.body.username,function(o){void 0===o[0]?e.send("没有该用户"):o[0].password===t.body.password?(t.session.islogin=t.body.username,e.locals.islogin=t.session.islogin,e.cookie("islogin",e.locals.islogin,{maxAge:6e4}),e.redirect("/home")):e.redirect("/login")})}),router.get("/logout",function(t,e){e.clearCookie("islogin"),t.session.destroy(),e.redirect("/")}),router.route("/reg").get(function(t,e){e.render("reg",{title:"注册"})}).post(function(t,e){client=userCon.connect();var o=t.body.username,i=t.body.password,a=uuidV4();userCon.userInsert(client,o,i,a,function(i){if(i)throw i;i?e.redirect("/regMsg"):(t.session.islogin=o,e.locals.islogin=t.session.islogin,e.cookie("islogin",e.locals.islogin,{maxAge:6e4}),e.redirect("/regMsg"))})}),router.route("/regMsg").get(function(t,e){t.session.islogin&&(e.locals.islogin=t.session.islogin),t.cookies.islogin&&(t.session.islogin=t.cookies.islogin);e.render("reg_msg",{msg:"注册成功",user:e.locals.islogin})});var side_bar_item_temp=require("../views/sideItemTemp.ejs");router.post("/newFolder",function(t,e,o){var i={note_name:"新建文件夹"},a=side_bar_item_temp({item:i});e.send({msg:"folder inited success",dom_data:a})});var search_bar_item_temp=require("../views/searchItemTemp.ejs");router.post("/newNote",function(t,e,o){var i={note_type:t.body.type},a=search_bar_item_temp({item:i});e.send({msg:"note inited success",dom_data:a})}),module.exports=router;