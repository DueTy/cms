function getDateTime(){return sd_time.format(new Date,"YYYY-MM-DD hh:mm:ss")}function getDate(e){return sd_time.format(e,"YYYY-MM-DD")}function calcuByteLength(e){var o=new Buffer(e),t=o.length;return t>1048576?(t/1048576).toFixed(0)+"MB":t>1024?(t/1024).toFixed(1)+"KB":t+"B"}var express=require("express"),router=express.Router(),dbCon=require("../dao/dbCon"),uuidV4=require("uuid/v4"),sd_time=require("silly-datetime"),art_temp=require("art-template");require.extensions[".ejs"]=art_temp.extension;var multer=require("multer"),md5=require("md5"),client=dbCon.connect();router.post("/getSearchNote",function(e,o,t){var n=e.body,i=n.keyword,r=(e.session.islogin.user_id,"select note_id,note_name,note_type,note_abstract,show_modify,note_size from note where note_name LIKE '%"+i+"%' order by modify_time DESC");dbCon.newestAndSearch(client,r,function(e,t){if(e)throw e;if(!e){for(var n=t,i="",r=0;r<n.length;r++)i+=search_bar_item_temp({item:n[r]});o.send({msg:"notes get successfully",list_dom:i,is_get:!0})}})}),router.get("/home",function(e,o){function t(e,o,n,i,r){if(++n>i)return!1;for(var s=0;s<o[n-1].length;s++){var d=o[n-1][s];d.par_folder_id===r&&(e.push(d),t(d.sub_list,o,n,i,d.folder_id))}}var n=[];e.session.islogin&&(o.locals.islogin=e.session.islogin),e.cookies.islogin&&(e.session.islogin=e.cookies.islogin);var i=o.locals.islogin;dbCon.folderSelect(client,i.user_id,function(e,r){if(e)throw e;if(!e){for(var s=1,d=[],_=[],l=0;l<r.length;l++)r[l].folder_level>s&&(s=r[l].folder_level),r[l].sub_list=[],d.push(r[l]);for(var l=0;l<s;l++)_.push(new Array);for(var l=0;l<d.length;l++)_[d[l].folder_level-1].push(d[l]);t(n,_,0,s,"root");var a={belong_folder_id:"root",user_id:i.user_id};dbCon.noteSelect(client,a,function(e,t){if(e)throw e;if(!e){var i=t;o.render("home",{title:"首页",user_msg:o.locals.islogin,side_data:n,search_data:i})}})}})}),router.get("/",function(e,o){e.cookies.islogin&&(e.session.islogin=e.cookies.islogin),e.session.islogin?(o.locals.islogin=e.session.islogin,o.redirect("/home")):(o.locals.islogin=e.session.islogin,o.redirect("/login"))}),router.route("/login").get(function(e,o){e.session.islogin&&(o.locals.islogin=e.session.islogin),e.cookies.islogin&&(e.session.islogin=e.cookies.islogin),o.render("login",{title:"用户登录",user:o.locals.islogin})}).post(function(e,o){result=null,dbCon.userSelect(client,e.body.username,function(t){if(void 0===t[0])o.send("没有该用户");else if(t[0].password===e.body.password){var n={user_name:e.body.username,user_id:t[0].user_id};e.session.islogin=n,o.locals.islogin=e.session.islogin,o.cookie("islogin",o.locals.islogin,{maxAge:6e4}),o.redirect("/home")}else o.redirect("/login")})}),router.get("/logout",function(e,o){o.clearCookie("islogin"),e.session.destroy(),o.redirect("/login")}),router.get("/share/:share_note_id/:note_type",function(e,o,t){var n=e.params.share_note_id,i=e.params.note_type,r={note_id:n,share_note_get:!0};dbCon.noteGet(client,r,function(e,t){if(e)throw e;var n=t[0].note_content,r=t[0].note_name;o.render("noteShare",{note_content:n,note_type:i,note_name:r})})}),router.route("/reg").get(function(e,o){o.render("reg",{title:"注册"})}).post(function(e,o){var t=e.body,n={user_id:uuidV4(),user_name:t.username,gender:t.gender,personal_desc:t.personal_desc,password:t.password,orgnazition_build_count:1,created_at:getDateTime(),belong_org_id:"",note_mag_permisstion:0},i=[n.user_id,n.user_name,n.gender,n.personal_desc,n.password,n.orgnazition_build_count,n.created_at,n.belong_org_id,n.note_mag_permisstion];dbCon.userInsert(client,i,function(t){if(t)throw t;t?o.redirect("/regMsg"):(e.session.islogin=n.user_name,o.locals.islogin=e.session.islogin,o.cookie("islogin",o.locals.islogin,{maxAge:6e4}),o.redirect("/regMsg"))})}),router.route("/regMsg").get(function(e,o){e.session.islogin&&(o.locals.islogin=e.session.islogin),e.cookies.islogin&&(e.session.islogin=e.cookies.islogin);o.render("regMsg",{msg:"注册成功",user:o.locals.islogin})}),router.route("/userMsgModify").get(function(e,o){}).post(function(e,o){var t=e.body,n=e.session.islogin.user_id,i={user_name:t.username,gender:t.gender,personal_desc:t.personal_desc,password:t.password,user_id:n};dbCon.userUpdate(client,i,function(t){if(t)throw t;t||(o.clearCookie("islogin"),e.session.destroy(),o.redirect("/login"))})}),router.post("/delFolder",function(e,o,t){function n(e,o,t,i,r){if(++t>i)return!1;for(var s=0;s<o[t-1].length;s++){var d=o[t-1][s];d.par_folder_id===r&&(e.push(d.folder_id),n(e,o,t,i,d.folder_id))}}var i,r=e.body;i=r.folder_level,start_folder_id=r.folder_id;var s=e.session.islogin,d=[];d.push(start_folder_id);var _=0,l=0;dbCon.folderSelect(client,s.user_id,function(e,t){if(e)throw e;if(!e){for(var r=1,s=[],a=[],c=0;c<t.length;c++)t[c].folder_level>r&&(r=t[c].folder_level),t[c].sub_list=[],s.push(t[c]);for(var c=0;c<r;c++)a.push(new Array);for(var c=0;c<s.length;c++)a[s[c].folder_level-1].push(s[c]);n(d,a,i,r,start_folder_id),dbCon.folderDel(client,d,function(e,t){if(e)throw e;if(!e){_=t.affectedRows;for(var n="",i=",",r=0;r<d.length;r++)r===d.length-1&&(i=""),n+="'"+d[r]+"'"+i;var s=" belong_folder_id in ("+n+")";dbCon.noteDel(client,s,function(e,t){if(e)throw e;e||(l=t.affectedRows,_===d.length?o.send({is_delete_all:!0,msg:"删除成功"}):o.send({is_delete_all:!1,msg:"删除失败"}))})}})}})}),router.post("/delNote",function(e,o,t){var n=e.body,i="note_id='"+n.note_id+"'";dbCon.noteDel(client,i,function(e,t){if(e)throw e;if(!e){var n=t.affectedRows>0;o.send({msg:"删除成功",is_delete:n})}})}),router.post("/getNewestNote",function(e,o,t){var n=(e.body,sd_time.format(new Date((new Date).getTime()-6048e5))),i=e.session.islogin.user_id,r="select note_id,note_name,note_type,note_abstract,show_modify,note_size from note where owner_id='"+i+"' and created_at>'"+n+"' order by modify_time DESC";dbCon.newestAndSearch(client,r,function(e,t){if(e)throw e;if(!e){for(var n=t,i="",r=0;r<n.length;r++)i+=search_bar_item_temp({item:n[r]});o.send({msg:"notes get successfully",list_dom:i,is_get:!0})}})});var side_bar_item_temp=require("../views/sideItemTemp.ejs");router.post("/newFolder",function(e,o,t){var n=(uuidV4(),e.body),i={};e.session.islogin&&(i=e.session.islogin);var r=getDateTime(),s=r,d={folder_id:uuidV4(),folder_name:"新建文件夹",folder_level:parseInt(n.par_folder_level)+1,belong_id:i.user_id,par_folder_id:n.par_folder_id,created_at:getDateTime(),modify_time:s},_=[d.folder_id,d.folder_name,d.folder_level,d.belong_id,d.par_folder_id,d.created_at,d.modify_time];dbCon.folderInsert(client,_,function(e){if(e)throw e;if(!e){var t={folder_name:d.folder_name,folder_level:d.folder_level,folder_id:d.folder_id},n=side_bar_item_temp({item:t});o.send({msg:"folder inited success",dom_data:n,folder_id:d.folder_id})}})});var search_bar_item_temp=require("../views/searchItemTemp.ejs");router.post("/newNote",function(e,o,t){var n=e.body,i=e.session.islogin,r=getDateTime(),s=getDate(r),d={note_id:uuidV4(),note_name:"新建笔记",note_type:n.type,owner_id:i.user_id,belong_folder_id:n.belong_folder_id,created_at:r,modify_time:r,show_modify:s,note_content:"",note_abstract:"",note_size:"0B"},_=[d.note_id,d.note_name,d.note_type,d.owner_id,d.belong_folder_id,d.created_at,d.modify_time,d.show_modify,d.note_content,d.note_abstract,d.note_size];dbCon.noteInsert(client,_,function(e,t){if(e)throw e;if(!e){var n={note_name:d.note_name,note_type:d.note_type,note_id:d.note_id,note_abstract:d.note_abstract,modify_date:d.modify_date,note_size:d.note_size},i=search_bar_item_temp({item:n});o.send({msg:"note inited success",dom_data:i})}})}),router.post("/getNoteList",function(e,o,t){var n=e.body.belong_folder_id,i="",r=[],s=e.session.islogin,d={user_id:s.user_id,belong_folder_id:n};dbCon.noteSelect(client,d,function(e,t){if(e)throw e;if(!e){r=t;for(var n=0;n<r.length;n++)i+=search_bar_item_temp({item:r[n]});o.send({msg:"folder's notes get successfully",list_dom:i})}})}),router.post("/saveNote",function(e,o,t){var n=e.body,i={user_id:e.session.islogin.user_id,note_content:n.note_content,note_id:n.note_id,note_abstract:n.note_abstract,note_size:calcuByteLength(n.note_content),show_modify:getDate(getDateTime())};dbCon.noteSave(client,i,function(e,t){if(e)throw e;if(!e){t.affectedRows>0&&o.send({is_saved:!0,msg:"内容修改成功"})}})}),router.post("/getNote",function(e,o,t){var n=e.body,i=n.note_id,r={note_id:i};dbCon.noteGet(client,r,function(e,t){if(e)throw e;if(!e){var n=t[0].note_content;o.send({is_get:!0,note_content:n})}})}),router.post("/rename",function(e,o,t){var n=e.body,i=getDateTime();"note"===n.entity_type&&(n.show_modify=getDate(i)),n.modify_time=i,n.val.length>20?o.send({msg:"名字太长了，要不短点？",is_tooLong:!0}):dbCon.renameFun(client,n,function(e,t){if(e)throw e;if(!e){var i=t.affectedRows>0;o.send({msg:n.entity_type+" rename success",is_tooLong:!1,new_name:n.val,is_affected:i})}})}),router.post("/verBack",function(e,o,t){var n=e.body,i={note_id:n.belong_note_id,ver_id:n.ver_id};dbCon.verBack(client,i,function(e,t){if(e)throw e;if(!e){var n=t.affectedRows>0;o.send({is_back:n})}})}),router.post("/verDel",function(e,o,t){var n=e.body,i=n.ver_id;dbCon.verDel(client,i,function(e,t){if(e)throw e;if(!e){console.log(t);var n=t.affectedRows>0;o.send({is_del:n})}})});var ver_item_temp=require("../views/verItemTemp.ejs");router.post("/verGet",function(e,o,t){var n=e.body,i={};"true"===n.is_belong_id?(i={select_opt:"note_id,created_at",where_opt:"belong_note_id='"+n.belong_note_id+"'"},dbCon.verGet(client,i,function(e,t){if(e)throw e;if(!e){var n=t.length>0;if(n){for(var i="",r=0;r<t.length;r++)t[r].created_at=sd_time.format(t[r].created_at,"YYYY-MM-DD hh:mm"),i+=ver_item_temp({item:t[r]});o.send({is_get:n,list_dom:i})}else o.send({is_get:n})}})):(i={select_opt:"note_content",where_opt:"note_id='"+n.ver_id+"'"},dbCon.verGet(client,i,function(e,t){if(e)throw e;if(!e){console.log(t);var n=t.length>0,i=t[0].note_content;o.send({is_get:n,note_content:i})}}))}),router.post("/verSave",function(e,o,t){var n=e.body,i={note_content:n.note_content,note_abstract:n.note_abstract,belong_note_id:n.belong_note_id,note_id:uuidV4(),note_type:n.note_type,created_user_id:e.session.islogin.user_id,created_at:getDateTime()},r=[i.note_id,i.belong_note_id,i.note_type,i.created_at,i.created_user_id,i.note_content,i.note_abstract];dbCon.verSave(client,r,function(e,t){if(e)throw e;if(!e){var n=t.affectedRows>0;n&&o.send({is_saved:n})}})}),module.exports=router;