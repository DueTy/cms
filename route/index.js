function getDateTime(){return sd_time.format(new Date,"YYYY-MM-DD hh:mm:ss")}var express=require("express"),router=express.Router(),dbCon=require("../dao/dbCon"),uuidV4=require("uuid/v4"),sd_time=require("silly-datetime"),art_temp=require("art-template");require.extensions[".ejs"]=art_temp.extension;for(var multer=require("multer"),md5=require("md5"),side_test_data=[],i=0;i<10;i++){var obj={folder_name:"笔记"+(i+1),level:1,folder_id:uuidV4(),sub_list:[]};side_test_data.push(obj)}for(var search_test_data=[],i=0;i<8;i++){var note_type=i%2==0?"note":"mk",obj={note_name:"日报 11.2"+(i+1),note_type:note_type,note_id:uuidV4()};search_test_data.push(obj)}router.get("/home",function(e,o){e.session.islogin&&(o.locals.islogin=e.session.islogin),e.cookies.islogin&&(e.session.islogin=e.cookies.islogin),o.render("home",{title:"首页",user_msg:o.locals.islogin,side_data:side_test_data,search_data:search_test_data})}),router.get("/",function(e,o){e.cookies.islogin&&(e.session.islogin=e.cookies.islogin),e.session.islogin&&(o.locals.islogin=e.session.islogin),o.render("index",{title:"首页",user:o.locals.islogin,side_data:side_test_data,search_data:search_test_data})}),router.route("/login").get(function(e,o){e.session.islogin&&(o.locals.islogin=e.session.islogin),e.cookies.islogin&&(e.session.islogin=e.cookies.islogin),o.render("login",{title:"用户登录",user:o.locals.islogin})}).post(function(e,o){client=dbCon.connect(),result=null,dbCon.userSelect(client,e.body.username,function(i){if(void 0===i[0])o.send("没有该用户");else if(console.log(i[0]),i[0].password===e.body.password){var s={user_name:e.body.username,user_id:i[0].user_id};e.session.islogin=s,o.locals.islogin=e.session.islogin,o.cookie("islogin",o.locals.islogin,{maxAge:6e4}),o.redirect("/home")}else o.redirect("/login")})}),router.get("/logout",function(e,o){o.clearCookie("islogin"),e.session.destroy(),o.redirect("/")}),router.route("/reg").get(function(e,o){o.render("reg",{title:"注册"})}).post(function(e,o){client=dbCon.connect();var i=e.body,s={user_id:uuidV4(),user_name:i.username,gender:i.gender,personal_desc:i.personal_desc,password:i.password,orgnazition_build_count:1,created_at:getDateTime(),belong_org_id:"",note_mag_permisstion:0},n=[s.user_id,s.user_name,s.gender,s.personal_desc,s.password,s.orgnazition_build_count,s.created_at,s.belong_org_id,s.note_mag_permisstion];dbCon.userInsert(client,n,function(i){if(i)throw i;i?o.redirect("/regMsg"):(e.session.islogin=s.user_name,o.locals.islogin=e.session.islogin,o.cookie("islogin",o.locals.islogin,{maxAge:6e4}),o.redirect("/regMsg"))})}),router.route("/regMsg").get(function(e,o){e.session.islogin&&(o.locals.islogin=e.session.islogin),e.cookies.islogin&&(e.session.islogin=e.cookies.islogin);o.render("regMsg",{msg:"注册成功",user:o.locals.islogin})});var side_bar_item_temp=require("../views/sideItemTemp.ejs");router.post("/newFolder",function(e,o,i){var s=dbCon.connect(),n=(uuidV4(),e.body),t={};e.session.islogin&&(t=e.session.islogin);var r={folder_id:uuidV4(),folder_name:"新建文件夹",folder_level:parseInt(n.par_folder_level)+1,belong_id:t.user_id,par_folder_id:n.par_folder_id,created_at:getDateTime()},d=[r.folder_id,r.folder_name,r.folder_level,r.belong_id,r.par_folder_id,r.created_at];dbCon.folderInsert(s,d,function(e){if(e)throw e;if(!e){var i={folder_name:r.folder_name,level:r.folder_level,folder_id:r.folder_id},s=side_bar_item_temp({item:i});o.send({msg:"folder inited success",dom_data:s,folder_id:r.folder_id})}})});var search_bar_item_temp=require("../views/searchItemTemp.ejs");router.post("/newNote",function(e,o,i){var s={note_name:"新建笔记",note_type:e.body.type,note_id:uuidV4()},n=search_bar_item_temp({item:s});o.send({msg:"note inited success",dom_data:n})}),router.post("/getNoteList",function(e,o,i){for(var s=(e.body.folder_id,""),n=[{note_name:"日报 11.25",note_type:"note",note_id:uuidV4()},{note_name:"日报 11.26",note_type:"mk",note_id:uuidV4()},{note_name:"日报 11.27",note_type:"note",note_id:uuidV4()},{note_name:"日报 11.28",note_type:"mk",note_id:uuidV4()}],t=0;t<n.length;t++)s+=search_bar_item_temp({item:n[t]});o.send({msg:"folder's notes get successfully",list_dom:s})}),router.post("/rename",function(e,o,i){var s=dbCon.connect(),n=e.body;dbCon.renameFun(s,n,function(e,i){if(e)throw e;e||o.send({msg:n.entity_type+" rename success",new_name:n.val,is_affected:i.affctedRows>0})})}),module.exports=router;