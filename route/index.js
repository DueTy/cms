function getDateTime(){return sd_time.format(new Date,"YYYY-MM-DD hh:mm:ss")}function getDate(e){return sd_time.format(e,"YYYY-MM-DD")}function calcuByteLength(e){var o=new Buffer(e),i=o.length;return i>1024?i/1024+"KB":i+"B"}var express=require("express"),router=express.Router(),dbCon=require("../dao/dbCon"),uuidV4=require("uuid/v4"),sd_time=require("silly-datetime"),art_temp=require("art-template");require.extensions[".ejs"]=art_temp.extension;var multer=require("multer"),md5=require("md5");router.get("/home",function(e,o){function i(e,o,n,s,r){if(++n>s)return!1;for(var t=0;t<o[n-1].length;t++){var l=o[n-1][t];l.par_folder_id===r&&(e.push(l),i(l.sub_list,o,n,s,l.folder_id))}}var n=dbCon.connect(),s=[];e.session.islogin&&(o.locals.islogin=e.session.islogin),e.cookies.islogin&&(e.session.islogin=e.cookies.islogin);var r=o.locals.islogin;dbCon.folderSelect(n,r.user_id,function(e,t){if(e)throw e;if(!e){for(var l=1,d=[],_=[],a=0;a<t.length;a++)t[a].folder_level>l&&(l=t[a].folder_level),t[a].sub_list=[],d.push(t[a]);for(var a=0;a<l;a++)_.push(new Array);for(var a=0;a<d.length;a++)_[d[a].folder_level-1].push(d[a]);i(s,_,0,l,"root");var f={belong_folder_id:"root",user_id:r.user_id};dbCon.noteSelect(n,f,function(e,i){if(e)throw e;if(!e){var n=i;o.render("home",{title:"首页",user_msg:o.locals.islogin,side_data:s,search_data:n})}})}})}),router.get("/",function(e,o){e.cookies.islogin&&(e.session.islogin=e.cookies.islogin),e.session.islogin?(o.locals.islogin=e.session.islogin,o.redirect("/home")):(o.locals.islogin=e.session.islogin,o.redirect("/login"))}),router.route("/login").get(function(e,o){e.session.islogin&&(o.locals.islogin=e.session.islogin),e.cookies.islogin&&(e.session.islogin=e.cookies.islogin),o.render("login",{title:"用户登录",user:o.locals.islogin})}).post(function(e,o){client=dbCon.connect(),result=null,dbCon.userSelect(client,e.body.username,function(i){if(void 0===i[0])o.send("没有该用户");else if(i[0].password===e.body.password){var n={user_name:e.body.username,user_id:i[0].user_id};e.session.islogin=n,o.locals.islogin=e.session.islogin,o.cookie("islogin",o.locals.islogin,{maxAge:6e4}),o.redirect("/home")}else o.redirect("/login")})}),router.get("/logout",function(e,o){o.clearCookie("islogin"),e.session.destroy(),o.redirect("/login")}),router.route("/reg").get(function(e,o){o.render("reg",{title:"注册"})}).post(function(e,o){client=dbCon.connect();var i=e.body,n={user_id:uuidV4(),user_name:i.username,gender:i.gender,personal_desc:i.personal_desc,password:i.password,orgnazition_build_count:1,created_at:getDateTime(),belong_org_id:"",note_mag_permisstion:0},s=[n.user_id,n.user_name,n.gender,n.personal_desc,n.password,n.orgnazition_build_count,n.created_at,n.belong_org_id,n.note_mag_permisstion];dbCon.userInsert(client,s,function(i){if(i)throw i;i?o.redirect("/regMsg"):(e.session.islogin=n.user_name,o.locals.islogin=e.session.islogin,o.cookie("islogin",o.locals.islogin,{maxAge:6e4}),o.redirect("/regMsg"))})}),router.route("/regMsg").get(function(e,o){e.session.islogin&&(o.locals.islogin=e.session.islogin),e.cookies.islogin&&(e.session.islogin=e.cookies.islogin);o.render("regMsg",{msg:"注册成功",user:o.locals.islogin})}),router.post("/delFolder",function(e,o,i){function n(e,o,i,s,r){if(++i>s)return!1;for(var t=0;t<o[i-1].length;t++){var l=o[i-1][t];l.par_folder_id===r&&(e.push(l.folder_id),n(e,o,i,s,l.folder_id))}}var s,r=dbCon.connect(),t=e.body;s=t.folder_level,start_folder_id=t.folder_id;var l=e.session.islogin,d=[];d.push(start_folder_id);var _=0,a=0;dbCon.folderSelect(r,l.user_id,function(e,i){if(e)throw e;if(!e){for(var t=1,l=[],f=[],u=0;u<i.length;u++)i[u].folder_level>t&&(t=i[u].folder_level),i[u].sub_list=[],l.push(i[u]);for(var u=0;u<t;u++)f.push(new Array);for(var u=0;u<l.length;u++)f[l[u].folder_level-1].push(l[u]);n(d,f,s,t,start_folder_id),dbCon.folderDel(r,d,function(e,i){if(e)throw e;if(!e){_=i.affectedRows;for(var n="",s=",",t=0;t<d.length;t++)t===d.length-1&&(s=""),n+="'"+d[t]+"'"+s;var l=" belong_folder_id in ("+n+")";dbCon.noteDel(r,l,function(e,i){if(e)throw e;e||(a=i.affectedRows,_===d.length?o.send({is_delete_all:!0,msg:"删除成功"}):o.send({is_delete_all:!1,msg:"删除失败"}))})}})}})}),router.post("/delNote",function(e,o,i){var n=dbCon.connect(),s=e.body,r="note_id='"+s.note_id+"'";dbCon.noteDel(n,r,function(e,i){if(e)throw e;if(!e){var n=i.affectedRows>0;o.send({msg:"删除成功",is_delete:n})}})});var side_bar_item_temp=require("../views/sideItemTemp.ejs");router.post("/newFolder",function(e,o,i){var n=dbCon.connect(),s=(uuidV4(),e.body),r={};e.session.islogin&&(r=e.session.islogin);var t=getDateTime(),l=t,d={folder_id:uuidV4(),folder_name:"新建文件夹",folder_level:parseInt(s.par_folder_level)+1,belong_id:r.user_id,par_folder_id:s.par_folder_id,created_at:getDateTime(),modify_time:l},_=[d.folder_id,d.folder_name,d.folder_level,d.belong_id,d.par_folder_id,d.created_at,d.modify_time];dbCon.folderInsert(n,_,function(e){if(e)throw e;if(!e){var i={folder_name:d.folder_name,folder_level:d.folder_level,folder_id:d.folder_id},n=side_bar_item_temp({item:i});o.send({msg:"folder inited success",dom_data:n,folder_id:d.folder_id})}})});var search_bar_item_temp=require("../views/searchItemTemp.ejs");router.post("/newNote",function(e,o,i){var n=dbCon.connect(),s=e.body,r=e.session.islogin,t=getDateTime(),l=getDate(t),d={note_id:uuidV4(),note_name:"新建笔记",note_type:s.type,owner_id:r.user_id,belong_folder_id:s.belong_folder_id,created_at:t,modify_time:t,show_modify:l,note_content:"",note_size:"0B"},_=[d.note_id,d.note_name,d.note_type,d.owner_id,d.belong_folder_id,d.created_at,d.modify_time,d.show_modify,d.note_content,d.note_size];dbCon.noteInsert(n,_,function(e,i){if(e)throw e;if(!e){var n={note_name:d.note_name,note_type:d.note_type,note_id:d.note_id,modify_date:d.modify_date,note_size:d.note_size},s=search_bar_item_temp({item:n});o.send({msg:"note inited success",dom_data:s})}})}),router.post("/getNoteList",function(e,o,i){var n=dbCon.connect(),s=e.body.belong_folder_id,r="",t=[],l=e.session.islogin,d={user_id:l.user_id,belong_folder_id:s};dbCon.noteSelect(n,d,function(e,i){if(e)throw e;if(!e){t=i;for(var n=0;n<t.length;n++)r+=search_bar_item_temp({item:t[n]});o.send({msg:"folder's notes get successfully",list_dom:r})}})}),router.post("/rename",function(e,o,i){var n=dbCon.connect(),s=e.body,r=getDateTime();"note"===s.entity_type&&(s.show_modify=getDate(r)),s.modify_time=r,s.val.length>20?o.send({msg:"名字太长了，要不短点？",is_tooLong:!0}):dbCon.renameFun(n,s,function(e,i){if(e)throw e;if(!e){var n=i.affectedRows>0;o.send({msg:s.entity_type+" rename success",is_tooLong:!1,new_name:s.val,is_affected:n})}})}),module.exports=router;