function getDateTime(){return sd_time.format(new Date,"YYYY-MM-DD hh:mm:ss")}function getDate(e){return sd_time.format(e,"YYYY-MM-DD")}function calcuByteLength(e){var o=new Buffer(e),i=o.length;return i>1024?i/1024+"KB":i+"B"}var express=require("express"),router=express.Router(),dbCon=require("../dao/dbCon"),uuidV4=require("uuid/v4"),sd_time=require("silly-datetime"),art_temp=require("art-template");require.extensions[".ejs"]=art_temp.extension;var multer=require("multer"),md5=require("md5");router.get("/home",function(e,o){function i(e,o,s,n,r){if(++s>n)return!1;for(var t=0;t<o[s-1].length;t++){var l=o[s-1][t];l.par_folder_id===r&&(e.push(l),i(l.sub_list,o,s,n,l.folder_id))}}var s=dbCon.connect(),n=[];e.session.islogin&&(o.locals.islogin=e.session.islogin),e.cookies.islogin&&(e.session.islogin=e.cookies.islogin);var r=o.locals.islogin;dbCon.folderSelect(s,r.user_id,function(e,t){if(e)throw e;if(!e){for(var l=1,d=[],a=[],_=0;_<t.length;_++)t[_].folder_level>l&&(l=t[_].folder_level),t[_].sub_list=[],d.push(t[_]);for(var _=0;_<l;_++)a.push(new Array);for(var _=0;_<d.length;_++)a[d[_].folder_level-1].push(d[_]);i(n,a,0,l,"root");var u={belong_folder_id:"root",user_id:r.user_id};dbCon.noteSelect(s,u,function(e,i){if(e)throw e;if(!e){var s=i;o.render("home",{title:"首页",user_msg:o.locals.islogin,side_data:n,search_data:s})}})}})}),router.get("/",function(e,o){e.cookies.islogin&&(e.session.islogin=e.cookies.islogin),e.session.islogin&&(o.locals.islogin=e.session.islogin),o.render("index",{title:"首页",user:o.locals.islogin,side_data:side_test_data,search_data:search_test_data})}),router.route("/login").get(function(e,o){e.session.islogin&&(o.locals.islogin=e.session.islogin),e.cookies.islogin&&(e.session.islogin=e.cookies.islogin),o.render("login",{title:"用户登录",user:o.locals.islogin})}).post(function(e,o){client=dbCon.connect(),result=null,dbCon.userSelect(client,e.body.username,function(i){if(void 0===i[0])o.send("没有该用户");else if(i[0].password===e.body.password){var s={user_name:e.body.username,user_id:i[0].user_id};e.session.islogin=s,o.locals.islogin=e.session.islogin,o.cookie("islogin",o.locals.islogin,{maxAge:6e4}),o.redirect("/home")}else o.redirect("/login")})}),router.get("/logout",function(e,o){o.clearCookie("islogin"),e.session.destroy(),o.redirect("/login")}),router.route("/reg").get(function(e,o){o.render("reg",{title:"注册"})}).post(function(e,o){client=dbCon.connect();var i=e.body,s={user_id:uuidV4(),user_name:i.username,gender:i.gender,personal_desc:i.personal_desc,password:i.password,orgnazition_build_count:1,created_at:getDateTime(),belong_org_id:"",note_mag_permisstion:0},n=[s.user_id,s.user_name,s.gender,s.personal_desc,s.password,s.orgnazition_build_count,s.created_at,s.belong_org_id,s.note_mag_permisstion];dbCon.userInsert(client,n,function(i){if(i)throw i;i?o.redirect("/regMsg"):(e.session.islogin=s.user_name,o.locals.islogin=e.session.islogin,o.cookie("islogin",o.locals.islogin,{maxAge:6e4}),o.redirect("/regMsg"))})}),router.route("/regMsg").get(function(e,o){e.session.islogin&&(o.locals.islogin=e.session.islogin),e.cookies.islogin&&(e.session.islogin=e.cookies.islogin);o.render("regMsg",{msg:"注册成功",user:o.locals.islogin})});var side_bar_item_temp=require("../views/sideItemTemp.ejs");router.post("/newFolder",function(e,o,i){var s=dbCon.connect(),n=(uuidV4(),e.body),r={};e.session.islogin&&(r=e.session.islogin);var t={folder_id:uuidV4(),folder_name:"新建文件夹",folder_level:parseInt(n.par_folder_level)+1,belong_id:r.user_id,par_folder_id:n.par_folder_id,created_at:getDateTime()},l=[t.folder_id,t.folder_name,t.folder_level,t.belong_id,t.par_folder_id,t.created_at];dbCon.folderInsert(s,l,function(e){if(e)throw e;if(!e){var i={folder_name:t.folder_name,folder_level:t.folder_level,folder_id:t.folder_id},s=side_bar_item_temp({item:i});o.send({msg:"folder inited success",dom_data:s,folder_id:t.folder_id})}})});var search_bar_item_temp=require("../views/searchItemTemp.ejs");router.post("/newNote",function(e,o,i){var s=dbCon.connect(),n=e.body,r=e.session.islogin,t=getDateTime(),l=getDate(t),d={note_id:uuidV4(),note_name:"新建笔记",note_type:n.type,owner_id:r.user_id,belong_folder_id:n.belong_folder_id,created_at:t,modify_date:l,note_content:"",note_size:"0B"},a=[d.note_id,d.note_name,d.note_type,d.owner_id,d.belong_folder_id,d.created_at,d.modify_date,d.note_content,d.note_size];dbCon.noteInsert(s,a,function(e,i){if(e)throw e;if(!e){var s={note_name:d.note_name,note_type:d.note_type,note_id:d.note_id,modify_date:d.modify_date,note_size:d.note_size},n=search_bar_item_temp({item:s});o.send({msg:"note inited success",dom_data:n})}})}),router.post("/getNoteList",function(e,o,i){var s=dbCon.connect(),n=e.body.belong_folder_id,r="",t=[],l=e.session.islogin,d={user_id:l.user_id,belong_folder_id:n};dbCon.noteSelect(s,d,function(e,i){if(e)throw e;if(!e){t=i,console.log(i);for(var s=0;s<t.length;s++)r+=search_bar_item_temp({item:t[s]});o.send({msg:"folder's notes get successfully",list_dom:r})}})}),router.post("/rename",function(e,o,i){var s=dbCon.connect(),n=e.body;dbCon.renameFun(s,n,function(e,i){if(e)throw e;if(!e){var s=i.affectedRows>0;o.send({msg:n.entity_type+" rename success",new_name:n.val,is_affected:s})}})}),module.exports=router;