function getDateTime(){return sd_time.format(new Date,"YYYY-MM-DD hh:mm:ss")}function getDate(e){return sd_time.format(e,"YYYY-MM-DD")}function calcuByteLength(e){var o=new Buffer(e),n=o.length;return n>1048576?(n/1048576).toFixed(0)+"MB":n>1024?(n/1024).toFixed(1)+"KB":n+"B"}var express=require("express"),router=express.Router(),dbCon=require("../dao/dbCon"),uuidV4=require("uuid/v4"),sd_time=require("silly-datetime"),art_temp=require("art-template");require.extensions[".ejs"]=art_temp.extension;var multer=require("multer"),md5=require("md5");router.get("/home",function(e,o){function n(e,o,i,t,s){if(++i>t)return!1;for(var r=0;r<o[i-1].length;r++){var d=o[i-1][r];d.par_folder_id===s&&(e.push(d),n(d.sub_list,o,i,t,d.folder_id))}}var i=dbCon.connect(),t=[];e.session.islogin&&(o.locals.islogin=e.session.islogin),e.cookies.islogin&&(e.session.islogin=e.cookies.islogin);var s=o.locals.islogin;dbCon.folderSelect(i,s.user_id,function(e,r){if(e)throw e;if(!e){for(var d=1,l=[],_=[],a=0;a<r.length;a++)r[a].folder_level>d&&(d=r[a].folder_level),r[a].sub_list=[],l.push(r[a]);for(var a=0;a<d;a++)_.push(new Array);for(var a=0;a<l.length;a++)_[l[a].folder_level-1].push(l[a]);n(t,_,0,d,"root");var f={belong_folder_id:"root",user_id:s.user_id};dbCon.noteSelect(i,f,function(e,n){if(e)throw e;if(!e){var i=n;o.render("home",{title:"首页",user_msg:o.locals.islogin,side_data:t,search_data:i})}})}})}),router.get("/",function(e,o){e.cookies.islogin&&(e.session.islogin=e.cookies.islogin),e.session.islogin?(o.locals.islogin=e.session.islogin,o.redirect("/home")):(o.locals.islogin=e.session.islogin,o.redirect("/login"))}),router.route("/login").get(function(e,o){e.session.islogin&&(o.locals.islogin=e.session.islogin),e.cookies.islogin&&(e.session.islogin=e.cookies.islogin),o.render("login",{title:"用户登录",user:o.locals.islogin})}).post(function(e,o){client=dbCon.connect(),result=null,dbCon.userSelect(client,e.body.username,function(n){if(void 0===n[0])o.send("没有该用户");else if(n[0].password===e.body.password){var i={user_name:e.body.username,user_id:n[0].user_id};e.session.islogin=i,o.locals.islogin=e.session.islogin,o.cookie("islogin",o.locals.islogin,{maxAge:6e4}),o.redirect("/home")}else o.redirect("/login")})}),router.get("/logout",function(e,o){o.clearCookie("islogin"),e.session.destroy(),o.redirect("/login")}),router.route("/reg").get(function(e,o){o.render("reg",{title:"注册"})}).post(function(e,o){client=dbCon.connect();var n=e.body,i={user_id:uuidV4(),user_name:n.username,gender:n.gender,personal_desc:n.personal_desc,password:n.password,orgnazition_build_count:1,created_at:getDateTime(),belong_org_id:"",note_mag_permisstion:0},t=[i.user_id,i.user_name,i.gender,i.personal_desc,i.password,i.orgnazition_build_count,i.created_at,i.belong_org_id,i.note_mag_permisstion];dbCon.userInsert(client,t,function(n){if(n)throw n;n?o.redirect("/regMsg"):(e.session.islogin=i.user_name,o.locals.islogin=e.session.islogin,o.cookie("islogin",o.locals.islogin,{maxAge:6e4}),o.redirect("/regMsg"))})}),router.route("/regMsg").get(function(e,o){e.session.islogin&&(o.locals.islogin=e.session.islogin),e.cookies.islogin&&(e.session.islogin=e.cookies.islogin);o.render("regMsg",{msg:"注册成功",user:o.locals.islogin})}),router.post("/delFolder",function(e,o,n){function i(e,o,n,t,s){if(++n>t)return!1;for(var r=0;r<o[n-1].length;r++){var d=o[n-1][r];d.par_folder_id===s&&(e.push(d.folder_id),i(e,o,n,t,d.folder_id))}}var t,s=dbCon.connect(),r=e.body;t=r.folder_level,start_folder_id=r.folder_id;var d=e.session.islogin,l=[];l.push(start_folder_id);var _=0,a=0;dbCon.folderSelect(s,d.user_id,function(e,n){if(e)throw e;if(!e){for(var r=1,d=[],f=[],c=0;c<n.length;c++)n[c].folder_level>r&&(r=n[c].folder_level),n[c].sub_list=[],d.push(n[c]);for(var c=0;c<r;c++)f.push(new Array);for(var c=0;c<d.length;c++)f[d[c].folder_level-1].push(d[c]);i(l,f,t,r,start_folder_id),dbCon.folderDel(s,l,function(e,n){if(e)throw e;if(!e){_=n.affectedRows;for(var i="",t=",",r=0;r<l.length;r++)r===l.length-1&&(t=""),i+="'"+l[r]+"'"+t;var d=" belong_folder_id in ("+i+")";dbCon.noteDel(s,d,function(e,n){if(e)throw e;e||(a=n.affectedRows,_===l.length?o.send({is_delete_all:!0,msg:"删除成功"}):o.send({is_delete_all:!1,msg:"删除失败"}))})}})}})}),router.post("/delNote",function(e,o,n){var i=dbCon.connect(),t=e.body,s="note_id='"+t.note_id+"'";dbCon.noteDel(i,s,function(e,n){if(e)throw e;if(!e){var i=n.affectedRows>0;o.send({msg:"删除成功",is_delete:i})}})});var side_bar_item_temp=require("../views/sideItemTemp.ejs");router.post("/newFolder",function(e,o,n){var i=dbCon.connect(),t=(uuidV4(),e.body),s={};e.session.islogin&&(s=e.session.islogin);var r=getDateTime(),d=r,l={folder_id:uuidV4(),folder_name:"新建文件夹",folder_level:parseInt(t.par_folder_level)+1,belong_id:s.user_id,par_folder_id:t.par_folder_id,created_at:getDateTime(),modify_time:d},_=[l.folder_id,l.folder_name,l.folder_level,l.belong_id,l.par_folder_id,l.created_at,l.modify_time];dbCon.folderInsert(i,_,function(e){if(e)throw e;if(!e){var n={folder_name:l.folder_name,folder_level:l.folder_level,folder_id:l.folder_id},i=side_bar_item_temp({item:n});o.send({msg:"folder inited success",dom_data:i,folder_id:l.folder_id})}})});var search_bar_item_temp=require("../views/searchItemTemp.ejs");router.post("/newNote",function(e,o,n){var i=dbCon.connect(),t=e.body,s=e.session.islogin,r=getDateTime(),d=getDate(r),l={note_id:uuidV4(),note_name:"新建笔记",note_type:t.type,owner_id:s.user_id,belong_folder_id:t.belong_folder_id,created_at:r,modify_time:r,show_modify:d,note_content:"",note_abstract:"",note_size:"0B"},_=[l.note_id,l.note_name,l.note_type,l.owner_id,l.belong_folder_id,l.created_at,l.modify_time,l.show_modify,l.note_content,l.note_abstract,l.note_size];dbCon.noteInsert(i,_,function(e,n){if(e)throw e;if(!e){var i={note_name:l.note_name,note_type:l.note_type,note_id:l.note_id,note_abstract:l.note_abstract,modify_date:l.modify_date,note_size:l.note_size},t=search_bar_item_temp({item:i});o.send({msg:"note inited success",dom_data:t})}})}),router.post("/getNoteList",function(e,o,n){var i=dbCon.connect(),t=e.body.belong_folder_id,s="",r=[],d=e.session.islogin,l={user_id:d.user_id,belong_folder_id:t};dbCon.noteSelect(i,l,function(e,n){if(e)throw e;if(!e){r=n;for(var i=0;i<r.length;i++)s+=search_bar_item_temp({item:r[i]});o.send({msg:"folder's notes get successfully",list_dom:s})}})}),router.post("/saveNote",function(e,o,n){var i=dbCon.connect(),t=e.body,s={user_id:e.session.islogin.user_id,note_content:t.note_content,note_id:t.note_id,note_abstract:t.note_abstract,note_size:calcuByteLength(t.note_content),show_modify:getDate(getDateTime())};dbCon.noteSave(i,s,function(e,n){if(e)throw e;if(!e){n.affectedRows>0&&o.send({is_saved:!0,msg:"内容修改成功"})}})}),router.post("/getNote",function(e,o,n){var i=dbCon.connect(),t=e.body,s=t.note_id,r={note_id:s};dbCon.noteGet(i,r,function(e,n){if(e)throw e;if(!e){var i=n[0].note_content;o.send({is_get:!0,note_content:i})}})}),router.post("/rename",function(e,o,n){var i=dbCon.connect(),t=e.body,s=getDateTime();"note"===t.entity_type&&(t.show_modify=getDate(s)),t.modify_time=s,t.val.length>20?o.send({msg:"名字太长了，要不短点？",is_tooLong:!0}):dbCon.renameFun(i,t,function(e,n){if(e)throw e;if(!e){var i=n.affectedRows>0;o.send({msg:t.entity_type+" rename success",is_tooLong:!1,new_name:t.val,is_affected:i})}})}),module.exports=router;